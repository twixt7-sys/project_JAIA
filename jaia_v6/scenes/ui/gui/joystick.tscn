[gd_scene load_steps=6 format=3 uid="uid://b0uryt1jeomv"]

[ext_resource type="Texture2D" uid="uid://bxsy5n2q5fxxr" path="res://assets/images/joystick2/joystick0.png" id="1_b5kbb"]
[ext_resource type="Texture2D" uid="uid://d1p24kmce85j6" path="res://assets/images/joystick2/joystick3.png" id="2_bo7gq"]
[ext_resource type="Texture2D" uid="uid://c8dd4tisg3kqh" path="res://assets/images/CharacterFrame.png" id="3_bo7gq"]

[sub_resource type="GDScript" id="GDScript_b5kbb"]
script/source = "extends Node2D

var posVector: Vector2
@export var deadzone = 15
"

[sub_resource type="GDScript" id="GDScript_4gnrm"]
script/source = "class_name MovementJoystick

extends Sprite2D


@onready var parent: Node2D = $\"..\"

@export var max_length: float = 50.0
@export var deadzone: float = 15.0

var _pressing: bool = false
var output_vector: Vector2 = Vector2.ZERO  # <--- The final joystick direction

func _process(delta: float) -> void:
	if _pressing:
		var raw_dir: Vector2 = get_global_mouse_position() - parent.global_position
		var clamped_dir: Vector2 = raw_dir.limit_length(max_length)
		global_position = parent.global_position + clamped_dir

		# normalize for output
		output_vector = clamped_dir / max_length

		# apply deadzone
		if output_vector.length() < deadzone / max_length:
			output_vector = Vector2.ZERO
	else:
		global_position = global_position.lerp(parent.global_position, delta * 50.0)
		output_vector = Vector2.ZERO

	ControlsManager.movement_joystick_vector = output_vector


func _on_button_pressed() -> void:
	_pressing = true


func _on_button_released() -> void:
	_pressing = false
	output_vector = Vector2.ZERO
"

[node name="MovementJoystick" type="Node2D"]
script = SubResource("GDScript_b5kbb")

[node name="Joyring" type="Sprite2D" parent="."]
scale = Vector2(4, 4)
texture = ExtResource("1_b5kbb")

[node name="Knob" type="Sprite2D" parent="."]
scale = Vector2(4, 4)
texture = ExtResource("2_bo7gq")
script = SubResource("GDScript_4gnrm")

[node name="Button" type="TouchScreenButton" parent="."]
modulate = Color(1, 1, 1, 0)
position = Vector2(-64, -65)
scale = Vector2(4, 4)
texture_normal = ExtResource("3_bo7gq")

[connection signal="pressed" from="Button" to="Knob" method="_on_button_pressed"]
[connection signal="released" from="Button" to="Knob" method="_on_button_released"]
